import React, { useState, useEffect } from 'react';
import { 
  Plane, Bus, MapPin, Camera, Utensils, ShoppingBag, 
  Hotel, Train, Sun, CloudSun, Moon, Copy, ExternalLink, 
  Navigation, AlertCircle, Ticket, CheckSquare, Briefcase, 
  Globe, Languages, Calculator, Wifi, Check, FileText, 
  Table, RefreshCw, Zap
} from 'lucide-react';

const TravelItineraryApp = () => {
  const [activeTab, setActiveTab] = useState('schedule'); // schedule, checklist, tools
  const [activeDay, setActiveDay] = useState(0);
  const [copiedId, setCopiedId] = useState(null);
  
  // Real-time Weather State
  const [weatherInfo, setWeatherInfo] = useState({ temp: '--', code: 0, loading: true });

  // Checklist State
  const [checkedItems, setCheckedItems] = useState({});

  const toggleCheck = (id) => {
    setCheckedItems(prev => ({
      ...prev,
      [id]: !prev[id]
    }));
  };

  const handleCopy = (e, text, id) => {
    e.stopPropagation();
    navigator.clipboard.writeText(text);
    setCopiedId(id);
    setTimeout(() => setCopiedId(null), 2000);
  };

  const getMapLink = (query) => `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(query)}`;

  // --- Image Assets ---
  const dayImages = [
    // D1: Mt Fuji Lake
    "https://images.unsplash.com/photo-1490806843957-31f4c9a91c65?auto=format&fit=crop&w=800&q=80", 
    // D2: Fuji-Q / Takabisha (Famous 121-degree drop view)
    "https://upload.wikimedia.org/wikipedia/commons/thumb/e/e0/Takabisha_roller_coaster.jpg/1200px-Takabisha_roller_coaster.jpg", 
    // D3: Chureito Pagoda
    "https://images.unsplash.com/photo-1524413840807-0c3cb6fa808d?auto=format&fit=crop&w=800&q=80", 
    // D4: Shinjuku Night
    "https://images.unsplash.com/photo-1540959733332-eab4deabeeaf?auto=format&fit=crop&w=800&q=80", 
    // D5: Shibuya Crossing
    "https://images.unsplash.com/photo-1542051841857-5f90071e7989?auto=format&fit=crop&w=800&q=80", 
    // D6: Airport/Plane
    "https://images.unsplash.com/photo-1536098561742-ca998e48cbcc?auto=format&fit=crop&w=800&q=80"  
  ];

  // --- Real-time Weather Fetching ---
  const locations = {
    fuji: { lat: 35.49, lon: 138.75 },
    tokyo: { lat: 35.68, lon: 139.76 }
  };

  const fetchWeather = async (lat, lon) => {
    setWeatherInfo(prev => ({ ...prev, loading: true }));
    try {
      const res = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current_weather=true`);
      const data = await res.json();
      setWeatherInfo({
        temp: Math.round(data.current_weather.temperature),
        code: data.current_weather.weathercode,
        loading: false
      });
    } catch (error) {
      console.error("Weather fetch failed", error);
      setWeatherInfo({ temp: 'N/A', code: 0, loading: false });
    }
  };

  // Weather Icon Mapping
  const getWeatherIcon = (code) => {
    if (code === 0) return <Sun className="text-yellow-400 drop-shadow-sm" />;
    if (code >= 1 && code <= 3) return <CloudSun className="text-white drop-shadow-sm" />;
    return <Sun className="text-yellow-400" />;
  };

  const getWeatherDesc = (code) => {
    if (code === 0) return "æ™´æœ—";
    if (code >= 1 && code <= 3) return "å¤šé›²æ™‚æ™´";
    if (code >= 51) return "æœ‰é›¨";
    return "é™°å¤©";
  };

  // --- Itinerary Data ---
  const itinerary = [
    {
      day: "D1",
      date: "11/30 (å…­)",
      locationName: "æ²³å£æ¹–",
      lat: locations.fuji.lat, lon: locations.fuji.lon,
      events: [
        { time: "09:00", icon: <Plane />, type: "transport", title: "èµ·é£›", desc: "å‰å¾€æ±äº¬æˆç”°/ç¾½ç”°", detail: "12:50 è½åœ°", searchKey: "æˆç”°æ©Ÿå ´" },
        { time: "14:00", icon: <Navigation />, type: "info", title: "å‡ºé—œ", desc: "é è¨ˆå‡ºé—œæ™‚é–“", searchKey: "æˆç”°æ©Ÿå ´" },
        { time: "14:40", icon: <Bus />, type: "transport", title: "æ©Ÿå ´å·´å£«", desc: "å‰å¾€æ²³å£æ¹– (è»Šç¨‹ç´„ 2:20)", detail: "ç¬¬ä¸‰èˆªå»ˆ 7è™Ÿæœˆå° / é è³¼ç¥¨ Â¥2520 / å–æ¶ˆè²» Â¥100", warning: "è¨˜å¾—å…ˆè²·è»Šç¥¨", searchKey: "æˆç”°æ©Ÿå ´ç¬¬ä¸‰èˆªå»ˆ å·´å£«ä¹˜è»Šè™•" },
        { time: "17:30", icon: <Hotel />, type: "stay", title: "Check-in æ°‘å®¿", desc: "Cool Stay & Smart Dining", detail: "æ”¾ä¸‹è¡Œæå¾Œå¯ç¨ä½œä¼‘æ¯", copyText: "Cool Stay & Smart Dining In The Fuji", searchKey: "Cool Stay & Smart Dining In The Fuji" },
        { time: "19:00", icon: <Utensils />, type: "food", title: "æ™šé¤", desc: "æ°‘å®¿é™„è¿‘æˆ–è¶…å•†è§£æ±º", searchKey: "æ²³å£æ¹– æ™šé¤" },
        { time: "æ™šé–“", icon: <Camera />, type: "spot", title: "å¤§çŸ³å…¬åœ’ / è‡ªç„¶ç”Ÿæ´»é¤¨", desc: "è‹¥æœ‰é«”åŠ›å¯å»ï¼Œå†¬å¤©æ²’æœ‰èŠ±", detail: "æ­æ²³å£æ¹–å‘¨éŠå·´å£«ç´…ç·šè‡³ã€Œæ²³å£æ¹–è‡ªç„¶ç”Ÿæ´»é¤¨ã€ç«™", searchKey: "æ²³å£æ¹–è‡ªç„¶ç”Ÿæ´»é¤¨" }
      ]
    },
    {
      day: "D2",
      date: "12/1 (æ—¥)",
      locationName: "å¯Œå£«æ€¥æ¨‚åœ’",
      lat: locations.fuji.lat, lon: locations.fuji.lon,
      note: "å…¨æ—¥æˆ°ç•¥è¡Œç¨‹ï¼šå„ªå…ˆåˆ¸é †åº é¬¼å±‹>é£›è»Š>å·¨äºº",
      events: [
        { time: "10:00", icon: <Ticket />, type: "spot", title: "è³¼è²·å„ªå…ˆåˆ¸", desc: "é †åºï¼šé¬¼å±‹ > é«˜é£›è»Š > é€²æ“Šçš„å·¨äºº", detail: "å…¥åœ’é¦–è¦ä»»å‹™", searchKey: "å¯Œå£«æ€¥æ¨‚åœ’ å”®ç¥¨è™•" },
        { time: "10:30", icon: <Zap />, type: "activity", title: "é«˜é£›è»Š (Takabisha)", desc: "ã€ä½¿ç”¨å¿«é€šã€‘", detail: "æœ€å¤§è½ä¸‹è§’åº¦ 121Â°", searchKey: "Takabisha Fuji-Q" },
        { time: "10:40", icon: <Navigation />, type: "activity", title: "è‡ªç”±è½é«” (Red Tower)", desc: "ç¾å ´æ’éšŠ", detail: "èˆ‡é«˜é£›è»Šç›¸é„°", searchKey: "Red Tower Fuji-Q" },
        { time: "11:20", icon: <Zap />, type: "activity", title: "ZOKKON", desc: "ã€ä½¿ç”¨å¿«é€šã€‘", detail: "æ©Ÿè»Šå¼é›²éœ„é£›è»Š", searchKey: "ZOKKON Fuji-Q" },
        { time: "11:30", icon: <Zap />, type: "activity", title: "æˆ°æ…„è¿·å®® (é¬¼å±‹)", desc: "ã€ä½¿ç”¨å¿«é€šã€‘", detail: "ä¸–ç•Œæœ€é•·é¬¼å±‹", searchKey: "Super Scary Labyrinth of Fear" },
        { time: "12:30", icon: <Navigation />, type: "activity", title: "æ€¥æµæ³›èˆŸ (Nagashimasuka)", desc: "ç¾å ´æ’éšŠ", detail: "å¯èƒ½æœƒæœ‰æ°´èŠ±", searchKey: "Nagashimasuka Fuji-Q" },
        { time: "12:50", icon: <Utensils />, type: "food", title: "åˆé¤ï¼šä¸€æ¨‚æ‹‰éºµ", desc: "ç«å½±å¿è€…ä¸»é¡Œé¤å»³", searchKey: "Ramen Ichiraku Fuji-Q" },
        { time: "13:20", icon: <ShoppingBag />, type: "shop", title: "æœ¨è‘‰å¿è€…æ‘", desc: "é€›è¡— + è·¯é‚Šå°éŠæˆ²", searchKey: "Naruto x Boruto Fuji Hidden Leaf Village" },
        { time: "14:10", icon: <Navigation />, type: "activity", title: "3D å°„æ“Šé“å ´", desc: "ç¾å ´æ’éšŠ", detail: "ç§‘å­¸å¿å…·é“å ´", searchKey: "Kagaku Ningu Dojo" },
        { time: "14:45", icon: <Navigation />, type: "activity", title: "å¿é“é¤¨ (è¨“ç·´å ´)", desc: "ç¾å ´æ’éšŠ", searchKey: "Fuji-Q Highland Naruto" },
        { time: "15:30", icon: <Zap />, type: "activity", title: "FUJIYAMA", desc: "ã€ä½¿ç”¨å¿«é€šã€‘", detail: "King of Coasters", searchKey: "FUJIYAMA roller coaster" },
        { time: "16:15", icon: <Navigation />, type: "activity", title: "æ‘©å¤©è¼ª", desc: "ç¾å ´æ’éšŠ", detail: "æ¬£è³å¯Œå£«å±±é»ƒæ˜æ™¯", searchKey: "Shining Flower Ferris Wheel" },
        { time: "16:45", icon: <Zap />, type: "activity", title: "é€²æ“Šçš„å·¨äºº", desc: "ã€ä½¿ç”¨å¿«é€šã€‘", searchKey: "Attack on Titan The Ride Fuji-Q" },
        { time: "17:00", icon: <Bus />, type: "transport", title: "é›¢åœ’", desc: "çµæŸæ¨‚åœ’è¡Œç¨‹", searchKey: "Fuji-Q Highland Station" }
      ]
    },
    {
      day: "D3",
      date: "12/2 (ä¸€)",
      locationName: "å±±ä¸­æ¹–/å¿é‡",
      lat: locations.fuji.lat, lon: locations.fuji.lon,
      note: "è·‘é»è¡Œç¨‹ï¼šå±±ä¸­æ¹– > å¿é‡å…«æµ· > æ·ºé–“ç¥ç¤¾ > å•†åº—è¡—",
      events: [
        { time: "05:30", icon: <Sun />, type: "info", title: "èµ·åºŠ", desc: "æº–å‚™å‡ºé–€", detail: "æ—©é¤ 06:40 åƒå®Œ" },
        { time: "07:00", icon: <Bus />, type: "transport", title: "å‰å¾€å±±ä¸­æ¹–", desc: "æ­ä¹˜è·¯ç·š 7 / 730 / 8", detail: "è»Šç¨‹ç´„ 40-50 min", searchKey: "æ²³å£æ¹–ç«™ å…¬è»Š" },
        { time: "08:00", icon: <Camera />, type: "spot", title: "å±±ä¸­æ¹–", desc: "ç§Ÿè…³è¸è»Š / ç™½é³¥æ¿±", detail: "09:00 å¯ç§Ÿè…³è¸è»Š", searchKey: "å±±ä¸­æ¹– ç™½é³¥æ¿±" },
        { time: "10:00", icon: <Bus />, type: "transport", title: "å‰å¾€å¿é‡å…«æµ·", desc: "æ­å…¬è»Šï¼Œç´„åŠå°æ™‚ä¸€ç­", searchKey: "å¿é‡å…«æµ·" },
        { time: "10:30", icon: <Camera />, type: "spot", title: "å¿é‡å…«æµ·", desc: "é¡æ± ã€ä¸­æ± ã€æ¹§æ± ã€æ¿æ± ", detail: "å¯è§¸æ‘¸å¯Œå£«å±±é›ªæ°´", searchKey: "å¿é‡å…«æµ·" },
        { time: "11:30", icon: <Utensils />, type: "food", title: "åˆé¤ï¼šæ± æœ¬èŒ¶å±‹", desc: "å¯Œå£«å±±æ°´åšçš„è•éº¥éºµ", detail: "å‚™æ¡ˆï¼šå½¥å…µè¡›çƒé¾éºµã€åæ³‰è•éº¥éºµ", copyText: "æ± æœ¬èŒ¶å±‹", searchKey: "æ± æœ¬èŒ¶å±‹ å¿é‡å…«æµ·" },
        { time: "12:45", icon: <Camera />, type: "spot", title: "å…«æµ·åº­åœ’ å½¦å…µè¡›å±‹æ•·", desc: "å‚³çµ±èŒ…è‰å±‹ / é–€ç¥¨ Â¥200", detail: "ç´„åœç•™ 10 min", searchKey: "å½¦å…µè¡›å±‹æ•·" },
        { time: "13:30", icon: <Bus />, type: "transport", title: "å‰å¾€ä¸‹å‰ç”°", desc: "æ­å…¬è»Šå›æ°‘å®¿è½‰è»Š æˆ– ç›´æ¥å‰å¾€", detail: "å¯æ­å¯Œå£«å‰ç”°/å¿é‡/å±±ä¸­æ¹–è§€å…‰å·´å£«", searchKey: "ä¸‹å‰ç”°ç«™" },
        { time: "14:30", icon: <Camera />, type: "spot", title: "æ–°å€‰å¯Œå£«æ·ºé–“ç¥ç¤¾", desc: "çˆ¬æ¨“æ¢¯ 20min åˆ°é ‚è§€æ™¯å°", warning: "è‘—åçš„äº”é‡å¡”+å¯Œå£«å±±æ™¯", searchKey: "æ–°å€‰å¯Œå£«æ·ºé–“ç¥ç¤¾" },
        { time: "16:40", icon: <ShoppingBag />, type: "shop", title: "æœ¬ç”ºäºŒä¸ç›®å•†åº—è¡—", desc: "æ‡·èˆŠå•†åº—è¡—æ‹ç…§", detail: "è‡ªç„¶è¡Œèµ°æ–‘é¦¬ç·šã€é•·ç„¦é¡æ‹æ”", searchKey: "æœ¬ç”ºäºŒä¸ç›®å•†åº—è¡—" },
        { time: "17:45", icon: <Camera />, type: "spot", title: "é‡‘é³¥å±…", desc: "æ‹ç…§å¾Œå›æ°‘å®¿", searchKey: "å¯Œå£«å±±é‡‘é³¥å±…" },
        { time: "18:30", icon: <Utensils />, type: "food", title: "æ™šé¤ï¼šTomifuji", desc: "Yoshida å®šé£Ÿ (ç‚¸è±¬æ’/ç”Ÿé­šç‰‡) æˆ– Tomifuji é°»é­šé£¯", copyText: "Tomifuji", searchKey: "Tomifuji é°»é­šé£¯" }
      ]
    },
    {
      day: "D4",
      date: "12/3 (äºŒ)",
      locationName: "æ–°å®¿",
      lat: locations.tokyo.lat, lon: locations.tokyo.lon,
      events: [
        { time: "06:00", icon: <Sun />, type: "info", title: "æ—©èµ·è¿½é€†å¯Œå£«", desc: "é¨è…³è¸è»Šå»æ²³å£æ¹–å¤§æ©‹", detail: "æ—¥å‡ºå‰ä¸€å°æ™‚æœ€ä½³ (ç´…é ­å¯Œå£«)", searchKey: "æ²³å£æ¹–å¤§æ©‹" },
        { time: "10:00", icon: <Bus />, type: "transport", title: "è»Šç«™å¯„æ”¾è¡Œæ", desc: "Baggage counter", detail: "æº–å‚™æ­éŠè¦½èˆ¹/çºœè»Š", searchKey: "æ²³å£æ¹–ç«™" },
        { time: "10:30", icon: <Navigation />, type: "activity", title: "æ²³å£æ¹–éŠè¦½èˆ¹", desc: "å¤©æ™´è™Ÿ (20min)", detail: "Â¥1000/äººï¼Œç¾å ´æ’éšŠå€™ä½", searchKey: "æ²³å£æ¹–éŠè¦½èˆ¹ å¤©æ™´è™Ÿ" },
        { time: "11:30", icon: <Camera />, type: "spot", title: "å¤©ä¸Šå±±å…¬åœ’ (çºœè»Š)", desc: "çµ•æ™¯ç›ªé¦éŸ† Â¥500", detail: "å¿…åƒï¼šå…”å­ç³°å­ã€å¯Œå£«å±±å†°æ£’ @ç‹¸è²“èŒ¶å±‹", searchKey: "æ²³å£æ¹–å¤©ä¸Šå±±å…¬åœ’" },
        { time: "14:10", icon: <Bus />, type: "transport", title: "é«˜é€Ÿå·´å£«", desc: "å‰å¾€æ–°å®¿ (é è¨ˆ 15:55 æŠµé”)", detail: "ä¸‹è»Šé»ï¼šBustaæ–°å®¿ (å—å£)", searchKey: "Busta Shinjuku" },
        { time: "16:40", icon: <Hotel />, type: "stay", title: "Check-in DOMO Hotel", desc: "æ”¾ç½®è¡Œæ", copyText: "DOMO Hotel Shinjuku", searchKey: "DOMO Hotel Shinjuku" },
        { time: "17:30", icon: <Utensils />, type: "food", title: "ä¸‹åˆèŒ¶", desc: "Afternoon Tea Love & Table", detail: "ä½æ–¼ Lumine 1", searchKey: "Afternoon Tea Love & Table Shinjuku" },
        { time: "18:30", icon: <ShoppingBag />, type: "shop", title: "æ–°å®¿ç™¾è²¨å·¡ç¦®", desc: "Lumine EST (å¹´è¼•æ½®æµ) / Lumine 2 (ç„¡å°è‰¯å“ 6F)", detail: "Beams, Onitsuka Tiger, Press Butter Sand", searchKey: "Lumine Est Shinjuku" },
        { time: "19:00", icon: <ShoppingBag />, type: "shop", title: "è¡—é‚Šè³¼ç‰©", desc: "Uniqlo Flagship / å”å‰è»»å¾·", detail: "Big Camera åŒæ£Ÿ Uniqlo", searchKey: "Uniqlo Shinjuku Honten" },
        { time: "21:10", icon: <Utensils />, type: "food", title: "æ™šé¤ï¼šé˜¿å¤«åˆ© (è¾›ç´…)", desc: "AFURI è¾›ç´…", warning: "L/O 21:30", copyText: "AFURI kara-kurenai Shinjuku", searchKey: "AFURI kara-kurenai Shinjuku" },
        { time: "22:30", icon: <Camera />, type: "spot", title: "æ±äº¬éµå¡”å¤œæ™¯", desc: "èŠå…¬åœ’ (23:00 ç†„ç‡ˆ)", searchKey: "èŠå…¬åœ’ æ±äº¬éµå¡”" }
      ]
    },
    {
      day: "D5",
      date: "12/4 (ä¸‰)",
      locationName: "åŸå®¿/æ¾€è°·",
      lat: locations.tokyo.lat, lon: locations.tokyo.lon,
      events: [
        { time: "09:00", icon: <MapPin />, type: "spot", title: "æ˜æ²»ç¥å®®", desc: "åŒ—å£é³¥å±… > æ­£æ®¿ > æ¸…æ­£äº• > å¾¡è‹‘", detail: "å¾¡è‹‘ Â¥500 (è‹¥æœ‰æ¥“è‘‰å†å»)", searchKey: "æ˜æ²»ç¥å®®" },
        { time: "10:10", icon: <Camera />, type: "spot", title: "ä»£ä»£æœ¨å…¬åœ’", desc: "æ«¸æ¨¹æ—è”­é“ (æ¥“è‘‰/éŠ€æ)", detail: "åŸå®¿é–€ã€å™´æ°´æ± è¥¿å´", searchKey: "ä»£ä»£æœ¨å…¬åœ’" },
        { time: "10:50", icon: <Utensils />, type: "food", title: "MARION CREPES", desc: "åŸå®¿å¯éº—é¤…", copyText: "MARION CREPES Harajuku", searchKey: "MARION CREPES Harajuku" },
        { time: "11:00", icon: <ShoppingBag />, type: "shop", title: "åŸå®¿è³¼ç‰©", desc: "@COSME / Asics / LaForet", detail: "LaForet: 1F Vivienne Westwood, 2F æ‰‹æ©Ÿæ®¼", searchKey: "Laforet Harajuku" },
        { time: "13:30", icon: <ShoppingBag />, type: "shop", title: "è¡¨åƒé“", desc: "ç²¾å“è¡— / Number Sugar ä¼´æ‰‹ç¦®", searchKey: "Number Sugar Omotesando" },
        { time: "14:30", icon: <Utensils />, type: "food", title: "åˆé¤ï¼šéºµæ•£", desc: "å¥¶æ²¹çƒé¾éºµ (éœ€æ’éšŠ)", copyText: "Menchirashi", searchKey: "Menchirashi" },
        { time: "16:30", icon: <Camera />, type: "spot", title: "SHIBUYA SKY", desc: "Scramble Square é ‚æ¨“ (éœ€é ç´„)", detail: "æ—¥è½æ™‚æ®µæœ€ä½³ / ç¦æ­¢å¸¶åŒ…åŒ… (éœ€ç½®ç‰©)", searchKey: "SHIBUYA SKY" },
        { time: "18:00", icon: <ShoppingBag />, type: "shop", title: "æ¾€è°·è³¼ç‰©", desc: "Parco / LOFT / 109", detail: "Parco: Human Made, North Face Lab, Nintendo", searchKey: "Shibuya PARCO" },
        { time: "19:00", icon: <Utensils />, type: "food", title: "æ™šé¤ï¼šå…­æ­Œä»™ç‡’è‚‰", desc: "æˆ– åˆ©ä¹…ç‰›èˆŒ / æ•˜æ•˜è‹‘ (å¤œæ™¯å»ºè­° Opera City åº—)", copyText: "Rokkasen Honten", searchKey: "Rokkasen Honten" },
        { time: "22:30", icon: <Utensils />, type: "food", title: "å®µå¤œï¼šæ–°å®¿ä¸²ç‡’", desc: "Yakitori Izakaya Kemuri", copyText: "Yakitori Izakaya Kemuri", searchKey: "Yakitori Izakaya Kemuri" }
      ]
    },
    {
      day: "D6",
      date: "12/5 (å››)",
      locationName: "æˆç”°æ©Ÿå ´",
      lat: locations.tokyo.lat, lon: locations.tokyo.lon,
      events: [
        { time: "10:30", icon: <Hotel />, type: "stay", title: "Check-out", desc: "æ•´ç†è¡Œæ", searchKey: "" },
        { time: "11:30", icon: <Utensils />, type: "food", title: "HARBS", desc: "Lumine EST B2", copyText: "HARBS Lumine Est", searchKey: "HARBS Lumine Est" },
        { time: "13:38", icon: <Train />, type: "transport", title: "N'EX æˆç”°å¿«ç·š", desc: "å‰å¾€æˆç”°æ©Ÿå ´ T1", detail: "33è™Ÿ / 14:08 æŠµé” (è»Šç¨‹ 1:20)", searchKey: "Narita Express" },
        { time: "17:45", icon: <Plane />, type: "transport", title: "èµ·é£›", desc: "Bye Bye Tokyo", searchKey: "Narita Airport Terminal 1" }
      ]
    }
  ];

  const checklistData = [
    { id: 'c1', category: 'å¿…å‚™æ–‡ä»¶', items: ['è­·ç…§ (æœ‰æ•ˆæœŸé™6å€‹æœˆä»¥ä¸Š)', 'Visit Japan Web (æˆªåœ–QR Code)', 'æ©Ÿç¥¨é›»å­æª”', 'ä½å®¿é è¨‚æ†‘è­‰'] },
    { id: 'c2', category: 'é›»å­ç”¢å“', items: ['ç¶²å¡ / eSIM (è¨­å®šå®Œæˆ)', 'è¡Œå‹•é›»æº', 'è½‰æ¥é ­/å……é›»å™¨', 'ç›¸æ©Ÿè¨˜æ†¶å¡'] },
    { id: 'c3', category: 'ç”Ÿæ´»ç”¨å“', items: ['å€‹äººå¸¸å‚™è—¥å“', 'ä¿æš–è¡£ç‰© (å¯Œå£«å±±æº«å·®å¤§)', 'ç‰™åˆ·/ç‰™è† (éƒ¨åˆ†æ°‘å®¿ä¸æä¾›)', 'å¥½èµ°çš„é‹å­'] },
    { id: 'c4', category: 'é‡‘éŒ¢èˆ‡æ”¯ä»˜', items: ['æ—¥å¹£ç¾é‡‘ (ç´„ Â¥50,000)', 'è¥¿ç“œå¡ (Suica/Pasmo) Apple Pay', 'ä¿¡ç”¨å¡ (JCB/Visa)', 'æµ·å¤–ææ¬¾é–‹é€š'] }
  ];

  const toolsData = [
    { title: "Google ç¿»è­¯", desc: "ç›¸æ©Ÿç¿»è­¯èœå–®å¿…å‚™", icon: <Languages />, url: "https://translate.google.com/?sl=ja&tl=zh-TW&op=translate" },
    { title: "ä¹˜æ›æ¡ˆå…§", desc: "æŸ¥è©¢é›»è»Šæ™‚åˆ»æœ€æº–ç¢º", icon: <Train />, url: "https://transit.yahoo.co.jp/" },
    { title: "Visit Japan Web", desc: "å…¥å¢ƒå¿«é€Ÿé€šé—œ", icon: <Globe />, url: "https://vjw-lp.digital.go.jp/zh-hant/" },
    { title: "åŒ¯ç‡æ›ç®—", desc: "å³æ™‚è¨ˆç®—å°å¹£åƒ¹æ ¼", icon: <Calculator />, url: "https://www.google.com/search?q=JPY+to+TWD" },
  ];

  // User Provided Links
  const userLinks = [
    { title: "è¡Œç¨‹è©³ç´°è¦åŠƒ (Doc)", desc: "Google Document", icon: <FileText />, url: "https://docs.google.com/document/d/18Oa8p5q-W6OYmJDv24yJl90vCNZXCzSIuZiUpx6ckHM/edit?tab=t.k94vu2a7584" },
    { title: "é ç®—èˆ‡æ¸…å–® (Sheet)", desc: "Google Spreadsheet", icon: <Table />, url: "https://docs.google.com/spreadsheets/d/1vGLUS_WY8YnUQE61gRHYg197-zslwYPJqu87aST4k0I/edit?gid=0#gid=0" }
  ];

  const getTypeColor = (type) => {
    switch (type) {
      case 'transport': return 'bg-blue-50 text-blue-700 border-blue-100';
      case 'spot': return 'bg-emerald-50 text-emerald-700 border-emerald-100';
      case 'food': return 'bg-orange-50 text-orange-700 border-orange-100';
      case 'shop': return 'bg-purple-50 text-purple-700 border-purple-100';
      case 'stay': return 'bg-indigo-50 text-indigo-700 border-indigo-100';
      case 'warning': return 'bg-red-50 text-red-700 border-red-100';
      default: return 'bg-gray-50 text-gray-700 border-gray-100';
    }
  };

  const activeData = itinerary[activeDay];

  // Fetch weather when active day changes
  useEffect(() => {
    if (activeTab === 'schedule') {
      fetchWeather(activeData.lat, activeData.lon);
    }
  }, [activeDay, activeTab]);

  return (
    <div className="max-w-md mx-auto bg-gray-50 min-h-screen shadow-2xl relative font-sans text-gray-800 pb-24 overflow-hidden">
      
      {/* --- Schedule View --- */}
      {activeTab === 'schedule' && (
        <>
          {/* Hero Header with Image */}
          <div className="relative h-64">
            <div className="absolute inset-0">
              <img 
                src={dayImages[activeDay]} 
                alt="Scenic View" 
                className="w-full h-full object-cover"
              />
              <div className="absolute inset-0 bg-gradient-to-t from-gray-900/90 via-gray-900/40 to-transparent" />
            </div>

            {/* Weather & Location Float Card */}
            <div className="absolute top-6 right-4 flex flex-col items-end gap-2 z-10">
              <div className="flex flex-col items-end bg-white/20 backdrop-blur-md p-2 px-3 rounded-2xl border border-white/20 text-white shadow-lg">
                <div className="flex items-center gap-2">
                  {weatherInfo.loading ? <RefreshCw className="animate-spin" size={16} /> : getWeatherIcon(weatherInfo.code)}
                  <span className="font-bold text-xl">{weatherInfo.loading ? '--' : `${weatherInfo.temp}Â°C`}</span>
                </div>
                <p className="text-[10px] font-medium opacity-90 mt-0.5">
                  {weatherInfo.loading ? 'æ›´æ–°ä¸­...' : `${getWeatherDesc(weatherInfo.code)} | ${activeData.locationName}`}
                </p>
              </div>
            </div>

            {/* Title & Date */}
            <div className="absolute bottom-4 left-6 text-white z-10">
              <p className="text-blue-200 text-xs font-bold tracking-wider uppercase mb-1">Current Trip</p>
              <h1 className="text-4xl font-black tracking-tight mb-1">{activeData.day}</h1>
              <p className="text-white/90 font-medium text-lg">{activeData.date}</p>
            </div>
          </div>

          {/* Date Tabs (Sticky) */}
          <div className="bg-white/95 backdrop-blur-sm sticky top-0 z-30 shadow-sm border-b border-gray-100">
            <div className="flex overflow-x-auto p-3 gap-2 no-scrollbar snap-x">
              {itinerary.map((item, index) => (
                <button
                  key={index}
                  onClick={() => setActiveDay(index)}
                  className={`flex-shrink-0 px-4 py-2 rounded-full text-xs font-bold transition-all snap-start ${
                    activeDay === index
                      ? 'bg-blue-600 text-white shadow-md shadow-blue-200'
                      : 'bg-gray-100 text-gray-500 hover:bg-gray-200'
                  }`}
                >
                  {item.day}
                </button>
              ))}
            </div>
          </div>

          {/* Note Banner */}
          {activeData.note && (
            <div className="mx-4 mt-4 p-3 bg-amber-50 border border-amber-100 text-amber-800 text-xs rounded-xl flex gap-3 shadow-sm">
              <AlertCircle size={16} className="flex-shrink-0 text-amber-500" />
              <span className="font-medium leading-relaxed">{activeData.note}</span>
            </div>
          )}

          {/* Timeline */}
          <div className="px-5 py-6 space-y-8 relative">
            <div className="absolute left-[27px] top-6 bottom-10 w-0.5 bg-gray-200/60" />
            
            {activeData.events.map((event, idx) => (
              <div key={idx} className="relative pl-12 group">
                {/* Dot */}
                <div className={`absolute left-[21px] top-5 w-3.5 h-3.5 rounded-full border-[3px] border-white shadow-sm z-10 box-content ${
                  event.type === 'transport' ? 'bg-blue-500' : 
                  event.type === 'food' ? 'bg-orange-500' : 
                  event.type === 'shop' ? 'bg-purple-500' : 'bg-emerald-500'
                }`} />

                {/* Time */}
                <span className="text-xs font-bold text-gray-400 mb-1.5 block font-mono tracking-wide">{event.time}</span>

                {/* Card */}
                <div className={`p-4 rounded-2xl border transition-all bg-white relative hover:scale-[1.02] active:scale-[0.98] duration-200 shadow-sm ${getTypeColor(event.type).replace('bg-', 'border-l-[6px] border-')}`}>
                  <div className="flex justify-between items-start gap-3">
                    <div className="flex-1 min-w-0">
                      <div className="flex items-center gap-2 mb-1.5">
                        <span className={`p-1 rounded-md ${getTypeColor(event.type)} bg-opacity-20`}>
                          {React.cloneElement(event.icon, { size: 14 })}
                        </span>
                        {event.searchKey ? (
                          <a 
                            href={getMapLink(event.searchKey)} 
                            target="_blank" 
                            rel="noopener noreferrer"
                            className="font-bold text-gray-800 text-lg hover:text-blue-600 truncate flex items-center gap-1.5 group/link"
                          >
                            {event.title}
                            <ExternalLink size={14} className="opacity-30 group-hover/link:opacity-100 transition-opacity" />
                          </a>
                        ) : (
                          <h3 className="font-bold text-gray-800 text-lg truncate">{event.title}</h3>
                        )}
                      </div>
                      <p className="text-sm text-gray-600 leading-relaxed font-medium">{event.desc}</p>
                    </div>

                    {/* Action Buttons */}
                    {event.copyText && (
                      <button 
                        onClick={(e) => handleCopy(e, event.copyText, idx)}
                        className="p-2 rounded-full bg-gray-50 text-gray-400 hover:text-blue-600 hover:bg-blue-50 transition-colors flex-shrink-0"
                      >
                        {copiedId === idx ? <Check size={18} className="text-green-500" /> : <Copy size={18} />}
                      </button>
                    )}
                  </div>
                  
                  {/* Tags */}
                  <div className="flex flex-wrap gap-2 mt-3.5">
                    {event.detail && (
                      <span className="text-[11px] bg-gray-100 text-gray-600 px-2.5 py-1 rounded-md font-medium flex items-center gap-1.5">
                        ğŸ’¡ {event.detail}
                      </span>
                    )}
                    {event.warning && (
                      <span className="text-[11px] bg-red-50 text-red-600 px-2.5 py-1 rounded-md font-medium flex items-center gap-1.5 border border-red-100/50">
                        âš ï¸ {event.warning}
                      </span>
                    )}
                  </div>
                </div>
              </div>
            ))}
          </div>

          {/* FAB */}
          <div className="fixed bottom-24 right-6 z-20">
            <button 
              onClick={() => window.open(getMapLink(activeData.locationName), '_blank')}
              className="bg-blue-600 text-white w-14 h-14 rounded-full shadow-xl shadow-blue-600/30 hover:bg-blue-700 transition-transform active:scale-90 flex items-center justify-center"
            >
              <Navigation size={26} />
            </button>
          </div>
        </>
      )}

      {/* --- Checklist View --- */}
      {activeTab === 'checklist' && (
        <div className="p-6 pt-12 animate-fade-in">
          <h2 className="text-2xl font-black mb-6 flex items-center gap-3 text-gray-800">
            <div className="p-2 bg-blue-100 rounded-lg text-blue-600">
              <CheckSquare size={24} />
            </div>
            è¡Œå‰æª¢æŸ¥
          </h2>
          <div className="space-y-6">
            {checklistData.map((group) => (
              <div key={group.id} className="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden">
                <div className="bg-gray-50/50 px-5 py-4 font-bold text-gray-700 flex items-center justify-between border-b border-gray-100">
                  {group.category}
                  <span className="text-xs bg-gray-200 text-gray-600 px-2 py-0.5 rounded-full">
                    {group.items.filter(item => checkedItems[`${group.id}-${item}`]).length} / {group.items.length}
                  </span>
                </div>
                <div className="divide-y divide-gray-50">
                  {group.items.map((item, i) => (
                    <div 
                      key={i} 
                      onClick={() => toggleCheck(`${group.id}-${item}`)}
                      className="px-5 py-4 flex items-center gap-4 cursor-pointer hover:bg-blue-50/50 transition-colors active:bg-blue-100/50"
                    >
                      <div className={`w-6 h-6 rounded-md border-2 flex items-center justify-center transition-all duration-200 ${
                        checkedItems[`${group.id}-${item}`] 
                          ? 'bg-blue-500 border-blue-500 scale-100' 
                          : 'border-gray-300 bg-white scale-95'
                      }`}>
                        {checkedItems[`${group.id}-${item}`] && <Check size={14} className="text-white" />}
                      </div>
                      <span className={`text-sm font-medium transition-all ${checkedItems[`${group.id}-${item}`] ? 'text-gray-400 line-through' : 'text-gray-700'}`}>
                        {item}
                      </span>
                    </div>
                  ))}
                </div>
              </div>
            ))}
          </div>
        </div>
      )}

      {/* --- Tools View --- */}
      {activeTab === 'tools' && (
        <div className="p-6 pt-12 animate-fade-in">
          <h2 className="text-2xl font-black mb-6 flex items-center gap-3 text-gray-800">
            <div className="p-2 bg-purple-100 rounded-lg text-purple-600">
              <Briefcase size={24} />
            </div>
            å¯¦ç”¨å·¥å…·
          </h2>

          {/* Personal Docs Section */}
          <div className="mb-8">
            <h3 className="text-sm font-bold text-gray-400 uppercase tracking-wider mb-3 ml-1">æˆ‘çš„è¡Œç¨‹æ–‡ä»¶</h3>
            <div className="grid grid-cols-1 gap-3">
              {userLinks.map((tool, idx) => (
                <a 
                  key={idx}
                  href={tool.url}
                  target="_blank"
                  rel="noopener noreferrer"
                  className="bg-white p-4 rounded-2xl border border-gray-100 shadow-sm hover:shadow-md hover:border-blue-200 transition-all flex items-center gap-4 group"
                >
                  <div className="w-12 h-12 rounded-xl bg-blue-50 text-blue-600 flex items-center justify-center group-hover:scale-110 transition-transform">
                    {tool.icon}
                  </div>
                  <div>
                    <h3 className="font-bold text-gray-800 text-lg">{tool.title}</h3>
                    <p className="text-xs text-gray-500 mt-0.5">{tool.desc}</p>
                  </div>
                  <ExternalLink size={16} className="ml-auto text-gray-300 group-hover:text-blue-400" />
                </a>
              ))}
            </div>
          </div>

          {/* Public Tools Section */}
          <div className="mb-6">
             <h3 className="text-sm font-bold text-gray-400 uppercase tracking-wider mb-3 ml-1">æ—¥æœ¬æ—…éŠå¿…å‚™</h3>
             <div className="grid grid-cols-2 gap-3">
              {toolsData.map((tool, idx) => (
                <a 
                  key={idx}
                  href={tool.url}
                  target="_blank"
                  rel="noopener noreferrer"
                  className="bg-white p-4 rounded-2xl border border-gray-100 shadow-sm hover:shadow-md hover:border-indigo-200 transition-all flex flex-col items-center text-center gap-3 group"
                >
                  <div className="w-10 h-10 rounded-full bg-indigo-50 text-indigo-600 flex items-center justify-center group-hover:rotate-12 transition-transform">
                    {tool.icon}
                  </div>
                  <div>
                    <h3 className="font-bold text-gray-700 text-sm">{tool.title}</h3>
                    <p className="text-[10px] text-gray-400 mt-1">{tool.desc}</p>
                  </div>
                </a>
              ))}
            </div>
          </div>
          
          <div className="bg-gradient-to-br from-indigo-50 to-blue-50 p-5 rounded-2xl border border-indigo-100">
            <h3 className="font-bold text-indigo-900 mb-3 flex items-center gap-2">
              <Wifi size={18} /> ç·Šæ€¥è¯çµ¡
            </h3>
            <div className="space-y-2">
              <div className="flex justify-between text-sm text-indigo-800 border-b border-indigo-200/50 pb-2">
                <span>è­¦å¯Ÿå±€</span>
                <span className="font-mono font-bold">110</span>
              </div>
              <div className="flex justify-between text-sm text-indigo-800 border-b border-indigo-200/50 pb-2">
                <span>ç«è­¦/æ•‘è­·</span>
                <span className="font-mono font-bold">119</span>
              </div>
              <div className="flex justify-between text-sm text-indigo-800">
                <span>é§æ—¥ä»£è¡¨è™•</span>
                <span className="font-mono font-bold">03-3280-7811</span>
              </div>
            </div>
          </div>
        </div>
      )}

      {/* Mobile Bottom Navigation (Tab Bar) */}
      <div className="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 pb-safe pt-2 z-50 shadow-[0_-5px_15px_rgba(0,0,0,0.05)]">
        <div className="flex justify-around items-center h-16 max-w-md mx-auto">
          <button 
            onClick={() => setActiveTab('schedule')}
            className={`flex flex-col items-center justify-center w-full h-full gap-1 transition-all ${
              activeTab === 'schedule' ? 'text-blue-600' : 'text-gray-400 hover:text-gray-500'
            }`}
          >
            <MapPin size={24} strokeWidth={activeTab === 'schedule' ? 2.5 : 2} />
            <span className="text-[10px] font-bold">è¡Œç¨‹</span>
          </button>
          
          <button 
            onClick={() => setActiveTab('checklist')}
            className={`flex flex-col items-center justify-center w-full h-full gap-1 transition-all ${
              activeTab === 'checklist' ? 'text-blue-600' : 'text-gray-400 hover:text-gray-500'
            }`}
          >
            <CheckSquare size={24} strokeWidth={activeTab === 'checklist' ? 2.5 : 2} />
            <span className="text-[10px] font-bold">æ¸…å–®</span>
          </button>
          
          <button 
            onClick={() => setActiveTab('tools')}
            className={`flex flex-col items-center justify-center w-full h-full gap-1 transition-all ${
              activeTab === 'tools' ? 'text-blue-600' : 'text-gray-400 hover:text-gray-500'
            }`}
          >
            <Briefcase size={24} strokeWidth={activeTab === 'tools' ? 2.5 : 2} />
            <span className="text-[10px] font-bold">å·¥å…·</span>
          </button>
        </div>
      </div>

    </div>
  );
};

export default TravelItineraryApp;